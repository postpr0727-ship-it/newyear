<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" id="viewportMeta" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
    <title>2026 ê¹€í¬ë‹¤ì¡°ì€ë³‘ì› ì‹ ë…„íšŒ ì´ë²¤íŠ¸</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @keyframes popIn {
            0% {
                transform: translate(-50%, -50%) scale(0);
            }
            100% {
                transform: translate(-50%, -50%) scale(1);
            }
        }

        @keyframes slideDown {
            0% {
                transform: translateX(-50%) translateY(-100%);
                opacity: 0;
            }
            100% {
                transform: translateX(-50%) translateY(0);
                opacity: 1;
            }
        }

        .marker {
            animation: popIn 0.3s ease-out;
        }

        .toast {
            animation: slideDown 0.3s ease-out;
        }

        .target-item.found img {
            border-color: #10b981 !important;
        }

        body {
            background-image: url('question/questionpaint.webp');
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
            background-repeat: no-repeat;
        }

        body.game-active {
            background: linear-gradient(135deg, #0f0f0f 0%, #1a1a1a 50%, #000000 100%);
            background-attachment: fixed;
        }

        .entry-overlay {
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(20px) saturate(180%);
            border: 1px solid rgba(255, 255, 255, 0.3);
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.25);
        }

        .glass-button {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px) saturate(180%);
            border: 1px solid rgba(255, 255, 255, 0.25);
            box-shadow: 0 4px 16px 0 rgba(31, 38, 135, 0.15);
            transition: all 0.3s ease;
        }

        .glass-button:hover {
            background: rgba(255, 255, 255, 0.2);
            box-shadow: 0 8px 24px 0 rgba(31, 38, 135, 0.25);
            transform: translateY(-2px);
        }

        .glass-button:active {
            transform: translateY(0);
        }

        .glass-input {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.25);
        }

        .glass-input:focus {
            background: rgba(255, 255, 255, 0.18);
            border-color: rgba(59, 130, 246, 0.5);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .glass-card {
            background: rgba(255, 255, 255, 0.08);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.15);
        }
    </style>
</head>
<body class="min-h-screen p-3 md:p-5 font-sans overflow-x-hidden">
    <!-- ì…ì¥ í™”ë©´ -->
    <div id="entryScreen" class="max-w-md mx-auto entry-overlay rounded-2xl p-2.5 md:p-3.5 shadow-2xl">
        <div class="text-center mb-2.5">
            <img src="logo/dajologo.png" alt="ê¹€í¬ë‹¤ì¡°ì€ë³‘ì› ë¡œê³ " class="max-w-[90px] md:max-w-[108px] h-auto mx-auto">
        </div>
        <h1 class="text-center text-gray-700 mb-1.5 text-xs md:text-sm font-semibold leading-tight">2026 ê¹€í¬ë‹¤ì¡°ì€ë³‘ì› ì‹ ë…„íšŒ</h1>
        <h2 class="text-center mb-2.5 text-base md:text-lg font-bold leading-tight" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f093fb 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; text-shadow: 0 2px 4px rgba(0,0,0,0.1);">"ì´ê²ƒ ë´ ë‚˜ë¥¼ í•œ ë²ˆ ì°¾ì•„ë´"</h2>
        <p class="text-center text-gray-600 text-[10px] md:text-xs mb-2.5">Â© 2024 Kim Kyung-hoon. All rights reserved.</p>
        
        <div class="glass-card p-2 rounded-lg mb-2.5 text-[10px] md:text-xs text-gray-800 leading-relaxed">
            <strong class="font-bold">ì„¤ëª…:</strong> ì‹œë¶€ì•¼ ìŠ¤í¬ë¨ë¸”ì— ìˆ¨ì€ 5ëª…ì˜ íƒ€ê²Ÿì„ ì°¾ì•„ë‚´ë¼ëŠ” ë³‘ì›ì¥ë‹˜ì˜ ëª…ë ¹ì´ ë–¨ì–´ì¡ŒìŠµë‹ˆë‹¤. ì—¬ëŸ¬ë¶„ì˜ ë¹ ë¥¸ ëˆˆìœ¼ë¡œ íƒ€ê²Ÿì„ ì°¾ì•„ë³´ì„¸ìš”! ì„ ì°©ìˆœìœ¼ë¡œ ìƒí’ˆì´ ì£¼ì–´ì§‘ë‹ˆë‹¤.ğŸ”­
        </div>

        <div class="mb-2">
            <label for="department" class="block mb-0.5 text-gray-800 font-bold text-[10px] md:text-xs">ë¶€ì„œëª…</label>
            <input type="text" id="department" placeholder="ë¶€ì„œëª…ì„ ì…ë ¥í•˜ì„¸ìš”" required
                class="w-full px-2 py-1 glass-input rounded-lg text-[10px] md:text-xs focus:outline-none transition-all text-gray-800 placeholder-gray-600">
        </div>

        <div class="mb-2">
            <label for="name" class="block mb-0.5 text-gray-800 font-bold text-[10px] md:text-xs">ì„±ëª…</label>
            <input type="text" id="name" placeholder="ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”" required
                class="w-full px-2 py-1 glass-input rounded-lg text-[10px] md:text-xs focus:outline-none transition-all text-gray-800 placeholder-gray-600">
        </div>

        <button id="enterBtn" class="w-full py-2 glass-button text-blue-700 rounded-lg text-xs md:text-sm font-extrabold mt-1.5 disabled:opacity-50 disabled:cursor-not-allowed disabled:hover:translate-y-0" style="background: rgba(59, 130, 246, 0.15); backdrop-filter: blur(10px); border: 2px solid rgba(59, 130, 246, 0.4);">
            ì…ì¥
        </button>

        <div id="waitingMessage" class="hidden text-center p-2.5 glass-card rounded-lg mt-2.5 text-blue-800 font-bold text-xs md:text-sm">
            ê²Œì„ ì‹œì‘ì„ ê¸°ë‹¤ë¦¬ê³  ìˆìŠµë‹ˆë‹¤...
        </div>

        <!-- ê´€ë¦¬ì íŒ¨ë„ -->
        <div id="adminPanel" class="hidden glass-card p-2.5 rounded-lg mt-2.5">
            <div class="mb-2.5">
                <h3 class="text-gray-800 mb-1.5 text-xs md:text-sm font-bold">ì°¸ê°€ ëŒ€ê¸° ì¸ì›</h3>
                <div id="participantCount" class="text-sm md:text-base text-blue-600 font-bold">0ëª…</div>
            </div>
            <button id="startGameBtn" class="w-full py-2 glass-button text-white rounded-lg text-xs md:text-sm font-bold mt-1.5 disabled:opacity-50 disabled:cursor-not-allowed disabled:hover:translate-y-0">
                ê²Œì„ ì‹œì‘
            </button>
            <button id="resetGameBtn" class="w-full py-2 glass-button text-white rounded-lg text-xs md:text-sm font-bold mt-1.5">
                ë°ì´í„° ë¦¬ì…‹
            </button>
            
            <div class="mt-2.5">
                <h3 class="mt-2.5 mb-2 text-xs md:text-sm font-bold text-gray-800">ê²Œì„ ì§„í–‰ ìƒí™©</h3>
                <div class="overflow-x-auto">
                    <table class="w-full border-collapse text-[10px] md:text-xs">
                        <thead>
                            <tr>
                                <th class="px-2 py-2 text-left bg-blue-600 text-white font-bold">ë¶€ì„œëª…</th>
                                <th class="px-2 py-2 text-left bg-blue-600 text-white font-bold">ì„±ëª…</th>
                                <th class="px-2 py-2 text-left bg-blue-600 text-white font-bold">ì°¾ì€ ê·¸ë¦¼</th>
                                <th class="px-2 py-2 text-left bg-blue-600 text-white font-bold">ì™„ë£Œ ì‹œê°„</th>
                            </tr>
                        </thead>
                        <tbody id="leaderboardBody" class="[&>tr:hover]:bg-gray-100">
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    
    <!-- ê´€ë¦¬ì ì…ì¥ í…ìŠ¤íŠ¸ (í™”ë©´ í•˜ë‹¨) -->
    <div class="text-center mt-2">
        <span id="adminBtn" class="text-gray-400 text-[10px] cursor-pointer hover:text-gray-600 transition-colors">ê´€ë¦¬ì ì…ì¥</span>
    </div>

    <!-- ê²Œì„ í™”ë©´ -->
    <div id="gameScreen" class="hidden max-w-full mx-auto p-6 md:p-8 overflow-hidden" style="background: rgba(20, 20, 30, 0.7); backdrop-filter: blur(20px); border-radius: 24px; border: 1px solid rgba(255, 255, 255, 0.1); box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);">
        <div class="flex justify-between items-center mb-4 p-3 rounded-xl" style="background: rgba(255, 255, 255, 0.08); border: 1px solid rgba(255, 255, 255, 0.1);">
            <div class="text-sm md:text-base text-gray-200" id="playerInfo"></div>
            <div class="font-bold text-blue-400 text-lg md:text-xl">
                ì°¾ì€ ê·¸ë¦¼: <span id="foundCount" class="text-blue-300">0</span> / 5
            </div>
        </div>

        <div id="targetsPreview" class="flex gap-3 overflow-x-auto py-3 mb-4">
            <!-- íƒ€ê²Ÿ ë¯¸ë¦¬ë³´ê¸°ê°€ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ì¶”ê°€ë©ë‹ˆë‹¤ -->
        </div>

        <div class="relative w-full mb-4" style="overflow: auto; -webkit-overflow-scrolling: touch;">
            <img src="question/questionpaint.webp" alt="ë¬¸ì œ ê·¸ë¦¼" id="questionImage" 
                class="rounded-xl block" style="touch-action: pan-x pan-y pinch-zoom; user-select: none; -webkit-user-drag: none; display: block; width: 100%; height: auto; max-width: none; box-shadow: 0 8px 32px rgba(0, 0, 0, 0.6);">
            <!-- ë§ˆì»¤ë“¤ì´ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ì¶”ê°€ë©ë‹ˆë‹¤ -->
        </div>
    </div>

    <!-- ì™„ë£Œ í™”ë©´ -->
    <div id="completionScreen" class="hidden max-w-full mx-auto bg-white rounded-3xl p-6 md:p-8 shadow-2xl text-center">
        <div class="text-6xl md:text-7xl mb-5">ğŸ‰</div>
        <div class="text-3xl md:text-4xl text-green-600 mb-5 font-bold">ê²Œì„ ì™„ë£Œ!</div>
        <div class="bg-gray-50 p-5 rounded-xl mb-5">
            <div class="mb-3 text-lg md:text-xl">
                <strong class="text-blue-600">ë¶€ì„œëª…:</strong> <span id="completionDept"></span>
            </div>
            <div class="mb-3 text-lg md:text-xl">
                <strong class="text-blue-600">ì„±ëª…:</strong> <span id="completionName"></span>
            </div>
            <div class="text-lg md:text-xl">
                <strong class="text-blue-600">ê²Œì„ ì‹œê°„:</strong> <span id="completionTime"></span>
            </div>
        </div>
        <div id="rankBadge" class="inline-block bg-gradient-to-r from-blue-500 to-green-500 text-white px-8 py-3 rounded-full text-xl md:text-2xl font-bold my-5">
            ë“±ìˆ˜: í™•ì¸ ì¤‘...
        </div>
    </div>

    <!-- ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸ ëª¨ë‹¬ -->
    <div id="adminModal" class="hidden fixed top-0 left-0 w-full h-full bg-black bg-opacity-70 z-[2000] items-center justify-center">
        <div class="bg-white p-8 rounded-2xl max-w-[90%] max-h-[90%] overflow-y-auto">
            <h2 class="mb-5 text-2xl font-bold text-gray-800">ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸</h2>
            <input type="password" id="adminPassword" placeholder="ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”"
                class="w-full px-4 py-3 mb-4 border-2 border-gray-300 rounded-lg text-base focus:outline-none focus:border-blue-500 transition-colors">
            <button id="adminLoginBtn" class="w-full py-4 bg-gradient-to-r from-blue-500 to-green-500 text-white rounded-lg text-lg font-bold hover:shadow-lg hover:-translate-y-0.5 transition-all duration-300">
                í™•ì¸
            </button>
            <button id="adminCancelBtn" class="w-full py-4 bg-gray-500 text-white rounded-lg text-lg font-bold mt-3 hover:shadow-lg hover:-translate-y-0.5 transition-all duration-300">
                ì·¨ì†Œ
            </button>
        </div>
    </div>

    <!-- í† ìŠ¤íŠ¸ ë©”ì‹œì§€ -->
    <div id="toast" class="hidden fixed top-5 left-1/2 -translate-x-1/2 bg-gray-800 text-white px-6 py-4 rounded-lg z-[1000] font-bold"></div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

    <script>
        // Firebase ì„¤ì • (ì‚¬ìš©ìê°€ Firebase í”„ë¡œì íŠ¸ë¥¼ ìƒì„±í•˜ê³  ì„¤ì •ê°’ì„ ì…ë ¥í•´ì•¼ í•©ë‹ˆë‹¤)
        // Firebase Console (https://console.firebase.google.com)ì—ì„œ í”„ë¡œì íŠ¸ë¥¼ ìƒì„±í•˜ê³ 
        // Realtime Databaseë¥¼ í™œì„±í™”í•œ í›„ ì•„ë˜ ì„¤ì •ê°’ì„ ì…ë ¥í•˜ì„¸ìš”.
        
        const firebaseConfig = {
            // Firebase í”„ë¡œì íŠ¸ ì„¤ì •
            apiKey: "AIzaSyAEqLtREV1qGz61R-Ny6hANB_Y9waeDqvw",
            authDomain: "newyear-event.firebaseapp.com",
            databaseURL: "https://newyear-event-default-rtdb.firebaseio.com",
            projectId: "newyear-event",
            storageBucket: "newyear-event.firebasestorage.app",
            messagingSenderId: "188022742082",
            appId: "1:188022742082:web:b87805729316c62d5121db"
        };

        // Firebase ì´ˆê¸°í™”
        let firebaseApp, database;
        
        // Firebase SDK ë¡œë“œë¥¼ ê¸°ë‹¤ë¦° í›„ ì´ˆê¸°í™”
        function initializeFirebase() {
            try {
                if (typeof firebase !== 'undefined' && firebase.apps && firebase.apps.length === 0) {
                    firebaseApp = firebase.initializeApp(firebaseConfig);
                    database = firebase.database();
                    console.log('Firebase ì´ˆê¸°í™” ì„±ê³µ');
                    return true;
                } else if (typeof firebase !== 'undefined' && firebase.apps && firebase.apps.length > 0) {
                    // ì´ë¯¸ ì´ˆê¸°í™”ëœ ê²½ìš°
                    firebaseApp = firebase.app();
                    database = firebase.database();
                    console.log('Firebase ì´ë¯¸ ì´ˆê¸°í™”ë¨');
                    return true;
                } else {
                    console.error('Firebase SDKê°€ ë¡œë“œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
                    database = null;
                    return false;
                }
            } catch (e) {
                console.error("Firebase ì´ˆê¸°í™” ì‹¤íŒ¨:", e);
                database = null;
                return false;
            }
        }
        
        // ì¦‰ì‹œ ì´ˆê¸°í™” ì‹œë„
        if (!initializeFirebase()) {
            // SDK ë¡œë“œë¥¼ ê¸°ë‹¤ë¦¼
            window.addEventListener('load', () => {
                setTimeout(() => {
                    if (!database) {
                        initializeFirebase();
                    }
                }, 500);
            });
        }

        // ê²Œì„ ìƒíƒœ
        const gameState = {
            isAdmin: false,
            department: '',
            name: '',
            foundTargets: [],
            startTime: null,
            gameStarted: false,
            playerId: null
        };

        // ì •ë‹µ ì¢Œí‘œ (ì´ë¯¸ì§€ í¬ê¸° 1500x2000 ê¸°ì¤€)
        // answerpaint.pngì˜ Target ë§ˆì»¤ ìœ„ì¹˜ ê¸°ë°˜
        const answerCoordinates = [
            { id: 1, x: 172, y: 2507, tolerance: 20 }, // Target 1
            { id: 2, x: 342, y: 1355, tolerance: 20 }, // Target 2
            { id: 3, x: 992, y: 1531, tolerance: 20 }, // Target 3
            { id: 4, x: 446, y: 2097, tolerance: 20 }, // Target 4
            { id: 5, x: 1763, y: 2231, tolerance: 20 } // Target 5
        ];

        // DOM ìš”ì†Œ
        const entryScreen = document.getElementById('entryScreen');
        const gameScreen = document.getElementById('gameScreen');
        const completionScreen = document.getElementById('completionScreen');
        const enterBtn = document.getElementById('enterBtn');
        const adminBtn = document.getElementById('adminBtn');
        const adminPanel = document.getElementById('adminPanel');
        const waitingMessage = document.getElementById('waitingMessage');
        const startGameBtn = document.getElementById('startGameBtn');
        const resetGameBtn = document.getElementById('resetGameBtn');
        const questionImage = document.getElementById('questionImage');
        const foundCountEl = document.getElementById('foundCount');
        const targetsPreview = document.getElementById('targetsPreview');
        const adminModal = document.getElementById('adminModal');
        const adminPassword = document.getElementById('adminPassword');
        const adminLoginBtn = document.getElementById('adminLoginBtn');
        const adminCancelBtn = document.getElementById('adminCancelBtn');
        const participantCount = document.getElementById('participantCount');
        const leaderboardBody = document.getElementById('leaderboardBody');
        const toast = document.getElementById('toast');

        // DOM ìš”ì†Œ í™•ì¸
        if (!enterBtn) {
            console.error('enterBtn ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
        }
        if (!toast) {
            console.error('toast ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
        }

        // ê³ ìœ  ID ìƒì„±
        function generateId() {
            return Date.now().toString(36) + Math.random().toString(36).substr(2);
        }

        // í† ìŠ¤íŠ¸ ë©”ì‹œì§€ í‘œì‹œ
        function showToast(message, type = 'success') {
            toast.textContent = message;
            toast.className = `fixed top-5 left-1/2 -translate-x-1/2 px-6 py-4 rounded-lg z-[1000] font-bold text-white toast`;
            if (type === 'success') {
                toast.classList.add('bg-green-500');
            } else if (type === 'error') {
                toast.classList.add('bg-red-500');
            } else {
                toast.classList.add('bg-blue-500');
            }
            toast.classList.remove('hidden');
            setTimeout(() => {
                toast.classList.add('hidden');
            }, 2000);
        }

        // íƒ€ê²Ÿ ë¯¸ë¦¬ë³´ê¸° ìƒì„±
        function createTargetsPreview() {
            targetsPreview.innerHTML = '';
            for (let i = 1; i <= 5; i++) {
                const targetItem = document.createElement('div');
                targetItem.className = 'min-w-[80px] text-center';
                targetItem.id = `target-preview-${i}`;
                targetItem.innerHTML = `
                    <img src="target/target${i}.png" alt="íƒ€ê²Ÿ ${i}" class="w-20 h-20 rounded-lg border-4 border-gray-300 object-contain">
                    <div class="text-xs mt-1 text-gray-300">íƒ€ê²Ÿ ${i}</div>
                `;
                targetsPreview.appendChild(targetItem);
            }
        }

        // ê²Œì„ ì‹œì‘ ìƒíƒœ í™•ì¸
        function checkGameStatus() {
            if (!database) return;
            
            database.ref('game/started').on('value', (snapshot) => {
                const started = snapshot.val();
                if (started && !gameState.gameStarted && gameState.playerId) {
                    startGame();
                }
            });
        }

        // ì…ì¥ ë²„íŠ¼ í´ë¦­
        if (enterBtn) {
            enterBtn.addEventListener('click', (e) => {
                e.preventDefault();
                e.stopPropagation();
                console.log('ì…ì¥ ë²„íŠ¼ í´ë¦­ë¨');
                
                const department = document.getElementById('department');
                const name = document.getElementById('name');
                
                if (!department || !name) {
                    console.error('ì…ë ¥ í•„ë“œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                    alert('ì…ë ¥ í•„ë“œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                    return;
                }
                
                const deptValue = department.value.trim();
                const nameValue = name.value.trim();

                console.log('ì…ë ¥ê°’:', { department: deptValue, name: nameValue });

                if (!deptValue || !nameValue) {
                    console.log('ì…ë ¥ê°’ì´ ë¹„ì–´ìˆìŒ');
                    showToast('ë¶€ì„œëª…ê³¼ ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'error');
                    return;
                }

                gameState.department = deptValue;
                gameState.name = nameValue;
                gameState.playerId = generateId();

                if (!database) {
                    console.error('Firebase ë°ì´í„°ë² ì´ìŠ¤ê°€ ì´ˆê¸°í™”ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
                    showToast('Firebase ì—°ê²°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë¸Œë¼ìš°ì € ì½˜ì†”ì„ í™•ì¸í•´ì£¼ì„¸ìš”.', 'error');
                    // Firebase ì—†ì´ ë¡œì»¬ í…ŒìŠ¤íŠ¸ ëª¨ë“œë¡œ ì§„í–‰
                    alert('Firebase ì—°ê²°ì´ ì—†ì–´ ë¡œì»¬ í…ŒìŠ¤íŠ¸ ëª¨ë“œë¡œ ì§„í–‰í•©ë‹ˆë‹¤.');
                    startGame();
                    return;
                }

                // ì°¸ê°€ì ë“±ë¡
                database.ref(`players/${gameState.playerId}`).set({
                    department: deptValue,
                    name: nameValue,
                    foundCount: 0,
                    completed: false,
                    completionTime: null,
                    joinedAt: Date.now()
                }).then(() => {
                    console.log('Firebase ë°ì´í„° ì €ì¥ ì„±ê³µ');
                    // ê²Œì„ ì‹œì‘ ìƒíƒœ í™•ì¸
                    return database.ref('game/started').once('value');
                }).then((snapshot) => {
                    const started = snapshot.val();
                    if (started) {
                        startGame();
                    } else {
                        if (waitingMessage) waitingMessage.classList.remove('hidden');
                        if (enterBtn) enterBtn.disabled = true;
                        checkGameStatus();
                    }
                }).catch((error) => {
                    console.error('Firebase ì˜¤ë¥˜:', error);
                    console.error('ì˜¤ë¥˜ ì½”ë“œ:', error.code);
                    console.error('ì˜¤ë¥˜ ë©”ì‹œì§€:', error.message);
                    
                    // ê¶Œí•œ ì˜¤ë¥˜ì¸ ê²½ìš°
                    if (error.code === 'PERMISSION_DENIED') {
                        showToast('Firebase ê¶Œí•œ ì˜¤ë¥˜: ë°ì´í„°ë² ì´ìŠ¤ ë³´ì•ˆ ê·œì¹™ì„ í™•ì¸í•´ì£¼ì„¸ìš”.', 'error');
                        alert('Firebase ê¶Œí•œ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.\n\nFirebase Console > Realtime Database > ê·œì¹™ íƒ­ì—ì„œ ë‹¤ìŒ ê·œì¹™ì„ ì„¤ì •í•´ì£¼ì„¸ìš”:\n\n{\n  "rules": {\n    ".read": true,\n    ".write": true\n  }\n}');
                    } else {
                        showToast('Firebase ì—°ê²° ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë¡œì»¬ ëª¨ë“œë¡œ ì§„í–‰í•©ë‹ˆë‹¤.', 'error');
                    }
                    startGame();
                });
            });
        } else {
            console.error('ì…ì¥ ë²„íŠ¼ ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ì–´ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆë¥¼ ë“±ë¡í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
        }

        // ê´€ë¦¬ì ì…ì¥ ë²„íŠ¼
        adminBtn.addEventListener('click', () => {
            adminModal.classList.remove('hidden');
            adminModal.classList.add('flex');
            adminPassword.focus();
        });

        // ê´€ë¦¬ì ë¡œê·¸ì¸
        adminLoginBtn.addEventListener('click', () => {
            if (adminPassword.value === '2024') {
                gameState.isAdmin = true;
                adminModal.classList.add('hidden');
                adminModal.classList.remove('flex');
                adminPanel.classList.remove('hidden');
                adminPassword.value = '';
                
                if (!database) {
                    showToast('Firebase ì„¤ì •ì´ í•„ìš”í•©ë‹ˆë‹¤.', 'error');
                    return;
                }

                // ê´€ë¦¬ì ëª¨ë“œ ì´ˆê¸°í™”
                setupAdminMode();
            } else {
                showToast('ë¹„ë°€ë²ˆí˜¸ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.', 'error');
            }
        });

        adminCancelBtn.addEventListener('click', () => {
            adminModal.classList.add('hidden');
            adminModal.classList.remove('flex');
            adminPassword.value = '';
        });

        // ê´€ë¦¬ì ëª¨ë“œ ì„¤ì •
        function setupAdminMode() {
            // ì°¸ê°€ì ìˆ˜ ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸
            database.ref('players').on('value', (snapshot) => {
                const players = snapshot.val() || {};
                const count = Object.keys(players).length;
                participantCount.textContent = `${count}ëª…`;
            });

            // ê²Œì„ ì‹œì‘ ë²„íŠ¼
            startGameBtn.addEventListener('click', () => {
                if (!database) {
                    showToast('Firebase ì„¤ì •ì´ í•„ìš”í•©ë‹ˆë‹¤.', 'error');
                    return;
                }

                database.ref('game/started').set(true);
                database.ref('game/startTime').set(Date.now());
                showToast('ê²Œì„ì´ ì‹œì‘ë˜ì—ˆìŠµë‹ˆë‹¤!', 'success');
                startGameBtn.disabled = true;
            });

            // ë°ì´í„° ë¦¬ì…‹ ë²„íŠ¼
            resetGameBtn.addEventListener('click', () => {
                if (!database) {
                    showToast('Firebase ì„¤ì •ì´ í•„ìš”í•©ë‹ˆë‹¤.', 'error');
                    return;
                }

                if (confirm('ëª¨ë“  ì°¸ê°€ì ë°ì´í„°ë¥¼ ì‚­ì œí•˜ê³  ê²Œì„ì„ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\nì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.')) {
                    // ëª¨ë“  ì°¸ê°€ì ë°ì´í„° ì‚­ì œ
                    database.ref('players').remove()
                        .then(() => {
                            // ê²Œì„ ìƒíƒœ ì´ˆê¸°í™”
                            database.ref('game').set({
                                started: false,
                                startTime: null
                            })
                            .then(() => {
                                showToast('ë°ì´í„°ê°€ ì„±ê³µì ìœ¼ë¡œ ë¦¬ì…‹ë˜ì—ˆìŠµë‹ˆë‹¤!', 'success');
                                startGameBtn.disabled = false;
                                participantCount.textContent = '0ëª…';
                                leaderboardBody.innerHTML = '';
                            })
                            .catch((error) => {
                                console.error('ê²Œì„ ìƒíƒœ ì´ˆê¸°í™” ì‹¤íŒ¨:', error);
                                showToast('ê²Œì„ ìƒíƒœ ì´ˆê¸°í™” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
                            });
                        })
                        .catch((error) => {
                            console.error('ë°ì´í„° ì‚­ì œ ì‹¤íŒ¨:', error);
                            showToast('ë°ì´í„° ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
                        });
                }
            });

            // ë¦¬ë”ë³´ë“œ ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸
            database.ref('players').orderByChild('completionTime').on('value', (snapshot) => {
                const players = snapshot.val() || {};
                const sortedPlayers = Object.entries(players)
                    .map(([id, data]) => ({ id, ...data }))
                    .filter(p => p.completed)
                    .sort((a, b) => {
                        if (a.completionTime === null) return 1;
                        if (b.completionTime === null) return -1;
                        return a.completionTime - b.completionTime;
                    });

                leaderboardBody.innerHTML = '';
                sortedPlayers.forEach((player, index) => {
                    const row = document.createElement('tr');
                    const time = player.completionTime ? 
                        formatTime(player.completionTime - (player.gameStartTime || 0)) : '-';
                    row.className = 'border-b border-gray-300';
                    row.innerHTML = `
                        <td class="px-3 py-3">${player.department}</td>
                        <td class="px-3 py-3">${player.name}</td>
                        <td class="px-3 py-3">${player.foundCount}/5</td>
                        <td class="px-3 py-3">${time}</td>
                    `;
                    leaderboardBody.appendChild(row);
                });
            });
        }

        // ê²Œì„ ì‹œì‘
        function startGame() {
            // ê²Œì„ í™”ë©´ ë°°ê²½ ì ìš©
            document.body.classList.add('game-active');
            
            if (!database) {
                // Firebase ì—†ì´ ë¡œì»¬ í…ŒìŠ¤íŠ¸ ëª¨ë“œ
                gameState.gameStarted = true;
                entryScreen.classList.add('hidden');
                gameScreen.classList.remove('hidden');
                
                // ê²Œì„ í™”ë©´ì—ì„œ í•€ì¹˜ ì¤Œ í™œì„±í™”
                const viewportMeta = document.getElementById('viewportMeta');
                if (viewportMeta) {
                    viewportMeta.setAttribute('content', 'width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes');
                }
                
                createTargetsPreview();
                setupGame();
                return;
            }

            gameState.gameStarted = true;
            gameState.startTime = Date.now();

            // ê²Œì„ ì‹œì‘ ì‹œê°„ ì €ì¥
            database.ref(`players/${gameState.playerId}/gameStartTime`).set(gameState.startTime);

            entryScreen.classList.add('hidden');
            gameScreen.classList.remove('hidden');
            waitingMessage.classList.add('hidden');

            // ê²Œì„ í™”ë©´ì—ì„œ í•€ì¹˜ ì¤Œ í™œì„±í™”
            const viewportMeta = document.getElementById('viewportMeta');
            if (viewportMeta) {
                viewportMeta.setAttribute('content', 'width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes');
            }

            document.getElementById('playerInfo').textContent = 
                `${gameState.department} ${gameState.name}`;

            createTargetsPreview();
            setupGame();
        }

        // ê²Œì„ ì„¤ì •
        function setupGame() {
            const gameContainer = questionImage.parentElement;
            let imageWidth = 0;
            let imageHeight = 0;
            let scaleX = 1;
            let scaleY = 1;
            let touchStartTime = 0;
            let touchStartX = 0;
            let touchStartY = 0;
            let hasMoved = false;

            // ì´ë¯¸ì§€ í¬ê¸° ì—…ë°ì´íŠ¸ í•¨ìˆ˜
            function updateImageScale() {
                // ì‹¤ì œ í‘œì‹œëœ ì´ë¯¸ì§€ì˜ ìì—°ìŠ¤ëŸ¬ìš´ í¬ê¸° ì‚¬ìš©
                const naturalWidth = questionImage.naturalWidth || 1500;
                const naturalHeight = questionImage.naturalHeight || 2000;
                
                imageWidth = questionImage.offsetWidth;
                imageHeight = questionImage.offsetHeight;
                
                // ìì—°ìŠ¤ëŸ¬ìš´ í¬ê¸° ê¸°ì¤€ìœ¼ë¡œ ìŠ¤ì¼€ì¼ ê³„ì‚°
                // í´ë¦­ ì¢Œí‘œë¥¼ ìì—°ìŠ¤ëŸ¬ìš´ í¬ê¸°ë¡œ ë³€í™˜í•˜ê¸° ìœ„í•œ ìŠ¤ì¼€ì¼
                scaleX = naturalWidth / imageWidth;
                scaleY = naturalHeight / imageHeight;
                
                console.log('ì´ë¯¸ì§€ í¬ê¸° ì—…ë°ì´íŠ¸:', {
                    natural: `${naturalWidth}x${naturalHeight}`,
                    display: `${imageWidth}x${imageHeight}`,
                    scale: `X:${scaleX.toFixed(3)}, Y:${scaleY.toFixed(3)}`
                });
            }

            questionImage.onload = () => {
                updateImageScale();
            };

            // ì´ë¯¸ì§€ê°€ ì´ë¯¸ ë¡œë“œëœ ê²½ìš°
            if (questionImage.complete) {
                updateImageScale();
            }

            // ë¦¬ì‚¬ì´ì¦ˆ ì‹œ ìŠ¤ì¼€ì¼ ì¬ê³„ì‚°
            window.addEventListener('resize', () => {
                updateImageScale();
            });

            // í´ë¦­ ì´ë²¤íŠ¸ (ë°ìŠ¤í¬í†±)
            questionImage.addEventListener('click', (e) => {
                if (!gameState.gameStarted) return;

                const rect = questionImage.getBoundingClientRect();
                // í´ë¦­í•œ í™”ë©´ ì¢Œí‘œë¥¼ ìì—°ìŠ¤ëŸ¬ìš´ ì´ë¯¸ì§€ í¬ê¸°ë¡œ ë³€í™˜
                const clickX = (e.clientX - rect.left) * scaleX;
                const clickY = (e.clientY - rect.top) * scaleY;

                // Ctrl í‚¤ë¥¼ ëˆ„ë¥¸ ìƒíƒœì—ì„œ í´ë¦­í•˜ë©´ ì¢Œí‘œë§Œ í‘œì‹œ (ë””ë²„ê¹… ëª¨ë“œ)
                if (e.ctrlKey || e.metaKey) {
                    e.preventDefault();
                    e.stopPropagation();
                    
                    const gameContainer = questionImage.parentElement;
                    const containerRect = gameContainer.getBoundingClientRect();
                    const naturalWidth = questionImage.naturalWidth || 1500;
                    const naturalHeight = questionImage.naturalHeight || 2000;
                    
                    // ì¢Œí‘œë¥¼ ì´ë¯¸ì§€ ìœ„ì— í‘œì‹œ (ì»¨í…Œì´ë„ˆ ê¸°ì¤€ìœ¼ë¡œ ìœ„ì¹˜ ê³„ì‚°)
                    const coordDiv = document.createElement('div');
                    coordDiv.style.position = 'absolute';
                    coordDiv.style.left = (e.clientX - containerRect.left) + 'px';
                    coordDiv.style.top = (e.clientY - containerRect.top) + 'px';
                    coordDiv.style.transform = 'translate(-50%, -100%)';
                    coordDiv.style.backgroundColor = 'rgba(255, 0, 0, 0.9)';
                    coordDiv.style.color = 'white';
                    coordDiv.style.padding = '10px 15px';
                    coordDiv.style.borderRadius = '8px';
                    coordDiv.style.fontSize = '16px';
                    coordDiv.style.fontWeight = 'bold';
                    coordDiv.style.zIndex = '10000';
                    coordDiv.style.pointerEvents = 'none';
                    coordDiv.style.whiteSpace = 'nowrap';
                    coordDiv.style.boxShadow = '0 4px 6px rgba(0,0,0,0.3)';
                    coordDiv.textContent = `x: ${Math.round(clickX)}, y: ${Math.round(clickY)}`;
                    
                    gameContainer.appendChild(coordDiv);
                    
                    // 10ì´ˆ í›„ ì œê±°
                    setTimeout(() => {
                        if (coordDiv.parentElement) {
                            coordDiv.remove();
                        }
                    }, 10000);
                    
                    // ì½˜ì†”ì—ë„ ì¶œë ¥ ë° ë³µì‚¬ ê°€ëŠ¥í•œ í˜•ì‹ ì œê³µ
                    const currentScaleX = naturalWidth / questionImage.offsetWidth;
                    const currentScaleY = naturalHeight / questionImage.offsetHeight;
                    const coordText = `{ id: N, x: ${Math.round(clickX)}, y: ${Math.round(clickY)}, tolerance: 120 }`;
                    console.log('=== ì •ë‹µ ì¢Œí‘œ (Ctrl+í´ë¦­) ===');
                    console.log('ìì—° ì´ë¯¸ì§€ í¬ê¸° ê¸°ì¤€ ì¢Œí‘œ:', { x: Math.round(clickX), y: Math.round(clickY) });
                    console.log('ìì—° ì´ë¯¸ì§€ í¬ê¸°:', `${naturalWidth}x${naturalHeight}`);
                    console.log('í‘œì‹œ ì´ë¯¸ì§€ í¬ê¸°:', `${questionImage.offsetWidth}x${questionImage.offsetHeight}`);
                    console.log('ìŠ¤ì¼€ì¼:', `X:${currentScaleX.toFixed(3)}, Y:${currentScaleY.toFixed(3)}`);
                    console.log('ì½”ë“œì— ì¶”ê°€í•  í˜•ì‹:', coordText);
                    console.log('================================');
                    alert(`ì¢Œí‘œ: x=${Math.round(clickX)}, y=${Math.round(clickY)}\n\nì´ ì¢Œí‘œë¥¼ answerCoordinates ë°°ì—´ì— ì‚¬ìš©í•˜ì„¸ìš”.\n\nì½˜ì†”(F12)ì—ì„œ ìì„¸í•œ ì •ë³´ë¥¼ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.`);
                    return;
                }

                checkAnswer(clickX, clickY, e.clientX - rect.left, e.clientY - rect.top);
            });

            // í„°ì¹˜ ì‹œì‘
            questionImage.addEventListener('touchstart', (e) => {
                if (!gameState.gameStarted) return;
                if (e.touches.length > 1) {
                    // í•€ì¹˜ ì œìŠ¤ì²˜ (í™•ëŒ€/ì¶•ì†Œ) ì¤‘ì¼ ë•ŒëŠ” ë¬´ì‹œ
                    hasMoved = true;
                    return;
                }
                
                touchStartTime = Date.now();
                touchStartX = e.touches[0].clientX;
                touchStartY = e.touches[0].clientY;
                hasMoved = false;
            }, { passive: true });

            // í„°ì¹˜ ì´ë™
            questionImage.addEventListener('touchmove', (e) => {
                if (!gameState.gameStarted) return;
                if (e.touches.length > 1) {
                    // í•€ì¹˜ ì œìŠ¤ì²˜ ì¤‘
                    hasMoved = true;
                    return;
                }
                
                if (touchStartTime > 0) {
                    const touch = e.touches[0];
                    const moveX = Math.abs(touch.clientX - touchStartX);
                    const moveY = Math.abs(touch.clientY - touchStartY);
                    
                    // 10í”½ì…€ ì´ìƒ ì´ë™í•˜ë©´ ì´ë™ìœ¼ë¡œ ê°„ì£¼
                    if (moveX > 10 || moveY > 10) {
                        hasMoved = true;
                    }
                }
            }, { passive: true });

            // í„°ì¹˜ ì¢…ë£Œ
            questionImage.addEventListener('touchend', (e) => {
                if (!gameState.gameStarted) return;
                if (e.changedTouches.length > 1) return; // ë©€í‹°í„°ì¹˜ ë¬´ì‹œ
                
                const touchDuration = Date.now() - touchStartTime;
                const touch = e.changedTouches[0];
                
                // ì´ë™ì´ ì—†ê³ , í„°ì¹˜ ì‹œê°„ì´ ì§§ìœ¼ë©´(300ms ì´í•˜) í´ë¦­ìœ¼ë¡œ ê°„ì£¼
                if (!hasMoved && touchDuration < 300) {
                    e.preventDefault();
                    
                    const rect = questionImage.getBoundingClientRect();
                    // í„°ì¹˜í•œ í™”ë©´ ì¢Œí‘œë¥¼ ìì—°ìŠ¤ëŸ¬ìš´ ì´ë¯¸ì§€ í¬ê¸°ë¡œ ë³€í™˜
                    const touchX = (touch.clientX - rect.left) * scaleX;
                    const touchY = (touch.clientY - rect.top) * scaleY;

                    // ë‘ ì†ê°€ë½ìœ¼ë¡œ í„°ì¹˜í•˜ë©´ ì¢Œí‘œë§Œ í‘œì‹œ (ë””ë²„ê¹… ëª¨ë“œ)
                    // ë‹¨ì¼ í„°ì¹˜ì´ë¯€ë¡œ ì •ìƒì ì¸ ê²Œì„ ì§„í–‰
                    checkAnswer(touchX, touchY, touch.clientX - rect.left, touch.clientY - rect.top);
                }
                
                // ë¦¬ì…‹
                touchStartTime = 0;
                hasMoved = false;
            });
        }

        // ì •ë‹µ í™•ì¸
        function checkAnswer(x, y, displayX, displayY) {
            // x, yëŠ” ì´ë¯¸ ìì—°ìŠ¤ëŸ¬ìš´ í¬ê¸° ê¸°ì¤€ìœ¼ë¡œ ë³€í™˜ëœ ì¢Œí‘œ
            const naturalWidth = questionImage.naturalWidth || 1500;
            const naturalHeight = questionImage.naturalHeight || 2000;
            
            // ë””ë²„ê¹…: í´ë¦­ ì¢Œí‘œ ì¶œë ¥ (ì½˜ì†”ì—ì„œ í™•ì¸ ê°€ëŠ¥)
            console.log('í´ë¦­ ì¢Œí‘œ:', {
                x: Math.round(x),
                y: Math.round(y),
                naturalSize: `${naturalWidth}x${naturalHeight}`,
                displaySize: `${questionImage.offsetWidth}x${questionImage.offsetHeight}`,
                'ì½”ë“œ í˜•ì‹': `{ id: N, x: ${Math.round(x)}, y: ${Math.round(y)}, tolerance: 120 }`
            });
            
            // ì´ë¯¸ ì°¾ì€ íƒ€ê²Ÿì¸ì§€ í™•ì¸
            for (const answer of answerCoordinates) {
                if (gameState.foundTargets.includes(answer.id)) {
                    continue;
                }

                // ìì—°ìŠ¤ëŸ¬ìš´ í¬ê¸° ê¸°ì¤€ìœ¼ë¡œ ì •ë‹µ ì¢Œí‘œ ì‚¬ìš© (ì´ë¯¸ ë³€í™˜ëœ x, yì™€ ì§ì ‘ ë¹„êµ)
                const distance = Math.sqrt(
                    Math.pow(x - answer.x, 2) + Math.pow(y - answer.y, 2)
                );

                // ë””ë²„ê¹…: ê° íƒ€ê²Ÿê¹Œì§€ì˜ ê±°ë¦¬ ì¶œë ¥
                console.log(`íƒ€ê²Ÿ ${answer.id}: ê±°ë¦¬=${distance.toFixed(2)}, í—ˆìš©ë²”ìœ„=${answer.tolerance}`);

                if (distance <= answer.tolerance) {
                    // ì •ë‹µ!
                    gameState.foundTargets.push(answer.id);
                    createMarker(displayX, displayY, true);
                    updateFoundCount();
                    updateTargetPreview(answer.id);
                    showToast(`íƒ€ê²Ÿ ${answer.id}ë¥¼ ì°¾ì•˜ìŠµë‹ˆë‹¤!`, 'success');

                    // Firebaseì— ì—…ë°ì´íŠ¸
                    if (database && gameState.playerId) {
                        database.ref(`players/${gameState.playerId}/foundCount`).set(gameState.foundTargets.length);
                    }

                    // ëª¨ë“  íƒ€ê²Ÿì„ ì°¾ì•˜ëŠ”ì§€ í™•ì¸ (5ê°œë¥¼ ëª¨ë‘ ì°¾ìœ¼ë©´ ìë™ìœ¼ë¡œ ì™„ë£Œ)
                    if (gameState.foundTargets.length === 5) {
                        handleGameCompletion();
                    }
                    return;
                }
            }

            // ì˜¤ë‹µ
            createMarker(displayX, displayY, false);
            showToast('ì •ë‹µì´ ì•„ë‹™ë‹ˆë‹¤. ë‹¤ì‹œ ì°¾ì•„ë³´ì„¸ìš”!', 'error');
        }

        // ë§ˆì»¤ ìƒì„±
        function createMarker(x, y, isCorrect) {
            const marker = document.createElement('div');
            marker.className = `absolute w-10 h-10 rounded-full border-4 transform -translate-x-1/2 -translate-y-1/2 pointer-events-none z-10 marker`;
            marker.style.left = x + 'px';
            marker.style.top = y + 'px';
            
            if (isCorrect) {
                marker.classList.add('border-green-500', 'bg-green-500', 'bg-opacity-20');
            } else {
                marker.classList.add('border-red-500', 'bg-red-500', 'bg-opacity-20');
            }
            
            const gameContainer = questionImage.parentElement;
            gameContainer.appendChild(marker);

            if (!isCorrect) {
                setTimeout(() => {
                    marker.remove();
                }, 1000);
            }
        }

        // ì°¾ì€ ê°œìˆ˜ ì—…ë°ì´íŠ¸
        function updateFoundCount() {
            foundCountEl.textContent = gameState.foundTargets.length;
        }

        // íƒ€ê²Ÿ ë¯¸ë¦¬ë³´ê¸° ì—…ë°ì´íŠ¸
        function updateTargetPreview(targetId) {
            const preview = document.getElementById(`target-preview-${targetId}`);
            if (preview) {
                preview.classList.add('found');
            }
        }

        // ì‹œê°„ í¬ë§·
        function formatTime(ms) {
            const seconds = Math.floor(ms / 1000);
            const minutes = Math.floor(seconds / 60);
            const secs = seconds % 60;
            return `${minutes}ë¶„ ${secs}ì´ˆ`;
        }

        // ê²Œì„ ì™„ë£Œ ì²˜ë¦¬ í•¨ìˆ˜
        function handleGameCompletion() {
            const completionTimestamp = Date.now(); // ë§ˆì§€ë§‰ ì •ë‹µ í´ë¦­ ì‹œì 
            const completionTime = completionTimestamp - gameState.startTime;

            // Firebaseì— ì™„ë£Œ ì •ë³´ ì €ì¥
            if (database && gameState.playerId) {
                database.ref(`players/${gameState.playerId}`).update({
                    completed: true,
                    completionTime: completionTimestamp
                });

                // ë“±ìˆ˜ í™•ì¸
                database.ref('players').orderByChild('completionTime').once('value', (snapshot) => {
                    const players = snapshot.val() || {};
                    const completedPlayers = Object.values(players)
                        .filter(p => p.completed && p.completionTime)
                        .sort((a, b) => a.completionTime - b.completionTime);
                    
                    const rank = completedPlayers.findIndex(p => 
                        p.department === gameState.department && 
                        p.name === gameState.name
                    ) + 1;

                    showCompletionScreen(completionTime, rank);
                });
            } else {
                showCompletionScreen(completionTime, 1);
            }
        }


        // ì™„ë£Œ í™”ë©´ í‘œì‹œ
        function showCompletionScreen(completionTime, rank) {
            // ê²Œì„ í™”ë©´ ë°°ê²½ ì œê±°
            document.body.classList.remove('game-active');
            
            gameScreen.classList.add('hidden');
            completionScreen.classList.remove('hidden');

            document.getElementById('completionDept').textContent = gameState.department;
            document.getElementById('completionName').textContent = gameState.name;
            document.getElementById('completionTime').textContent = formatTime(completionTime);
            document.getElementById('rankBadge').textContent = `ë“±ìˆ˜: ${rank}ë“±`;
        }

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ë¯¸ì§€ í¬ê¸° í™•ì¸
        window.addEventListener('load', () => {
            if (questionImage.complete) {
                const imageWidth = questionImage.offsetWidth;
                const imageHeight = questionImage.offsetHeight;
                console.log('ì´ë¯¸ì§€ í¬ê¸°:', imageWidth, 'x', imageHeight);
            }
        });
    </script>
</body>
</html>
